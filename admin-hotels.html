<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin | Gestion des Hôtels</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="authSection" class="flex flex-col items-center justify-center h-screen space-y-4">
  <button onclick="login()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
    🔐 Se connecter avec Google
  </button>
  <div id="debugInfo" class="text-sm text-gray-600"></div>
</div>

<div id="adminSection" class="hidden px-6 py-10 max-w-6xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-center">📊 Hôtels ajoutés</h1>
  <div id="adminHotelList" class="grid md:grid-cols-2 gap-6"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore, collection, getDocs, deleteDoc, doc, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBo9JsPem6NqNWL1DHiPQFck5PLJvADRUI",
    authDomain: "congo-reservation.firebaseapp.com",
    projectId: "congo-reservation",
    storageBucket: "congo-reservation.appspot.com",
    messagingSenderId: "54528039217",
    appId: "1:54528039217:web:8158927e3b22c8a24a3810"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const authorizedEmails = ["label.diak@gmail.com", "nkoukasylvanie@gmail.com"];
  const debugInfo = document.getElementById("debugInfo");

  // 🔁 Connexion automatique si déjà connecté
  onAuthStateChanged(auth, (user) => {
    if (user && authorizedEmails.includes(user.email)) {
      document.getElementById("authSection").classList.add("hidden");
      document.getElementById("adminSection").classList.remove("hidden");
      loadHotels();
    }
  });

  window.login = () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        const email = result.user.email;
        debugInfo.innerText = "🔐 Connecté : " + email;

        if (authorizedEmails.includes(email)) {
          document.getElementById("authSection").classList.add("hidden");
          document.getElementById("adminSection").classList.remove("hidden");
          loadHotels();
        } else {
          alert("⛔ Accès refusé à : " + email);
          debugInfo.innerText += "\n⛔ Non autorisé.";
        }
      })
      .catch((error) => {
        console.error("❌ Erreur d'authentification :", error);
        debugInfo.innerText = "❌ Erreur : " + error.message;
      });
  };

  async function loadHotels() {
    const list = document.getElementById("adminHotelList");
    list.innerHTML = "Chargement...";
    const snapshot = await getDocs(collection(db, "hotels"));
    list.innerHTML = "";

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;
      const isValid = data.validé === true;
      const isOnline = data.publie === true;
      const nbImages = Array.isArray(data.images) ? data.images.length : 0;
      const firstImage = data.imageUrl || (Array.isArray(data.images) && data.images[0]) || '';

      list.innerHTML += `
        <div class="bg-white shadow rounded p-4 relative">
          <img src="${firstImage}" class="w-full h-40 object-cover rounded mb-2" onerror="this.style.display='none';">
          <h3 class="text-xl font-semibold">${data.nom}</h3>
          <p><strong>Ville:</strong> ${data.ville}</p>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Description:</strong> ${data.description || 'Aucune'}</p>
          <p><strong>Nombre d’images:</strong> ${nbImages}</p>
          <p><strong>Status:</strong>
            <span class="text-sm px-2 py-1 rounded ${isValid ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
              ${isValid ? 'Validé' : 'En attente'}
            </span>
            <span class="text-sm px-2 py-1 rounded ${isOnline ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
              ${isOnline ? 'Publié' : 'Hors ligne'}
            </span>
          </p>
          <div class="mt-4 space-x-2">
            <button onclick="validateHotel('${id}')" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">✅ Valider</button>
            <button onclick="togglePublish('${id}', ${isOnline})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
              ${isOnline ? '🚫 Dépublier' : '🌐 Publier'}
            </button>
            <button onclick="deleteHotel('${id}')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">🗑 Supprimer</button>
          </div>
        </div>
      `;
    });
  }

  window.validateHotel = async (id) => {
    await updateDoc(doc(db, "hotels", id), { validé: true });
    alert("✅ Hôtel validé !");
    loadHotels();
  };

  window.togglePublish = async (id, current) => {
    await updateDoc(doc(db, "hotels", id), { publie: !current });
    alert(`🔁 Hôtel ${!current ? "publié" : "dépublié"} !`);
    loadHotels();
  };

  window.deleteHotel = async (id) => {
    if (confirm("⚠️ Supprimer cet hôtel ?")) {
      await deleteDoc(doc(db, "hotels", id));
      alert("🗑 Supprimé !");
      loadHotels();
    }
  };
</script>
</body>
</html>
