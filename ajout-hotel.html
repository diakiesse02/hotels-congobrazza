<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ajouter un Hôtel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- Section Authentification -->
<div id="authSection" class="flex items-center justify-center h-screen">
  <button onclick="login()" class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700">
    🔐 Se connecter avec Google
  </button>
</div>

<!-- Section Formulaire -->
<div id="formSection" class="hidden px-4 py-8 max-w-2xl mx-auto">
  <h1 class="text-3xl font-bold mb-6 text-center">➕ Ajouter un Hôtel</h1>
  <form id="hotelForm" class="grid gap-4">
    <input type="text" placeholder="Nom de l'hôtel" id="hotelNom" required class="p-3 border rounded">
    <input type="text" placeholder="Ville" id="hotelVille" required class="p-3 border rounded">
    <input type="email" placeholder="Email de contact" id="hotelEmail" required class="p-3 border rounded">
    <textarea placeholder="Description" id="hotelDescription" required class="p-3 border rounded"></textarea>

    <div class="border rounded p-4">
      <p class="font-semibold mb-2">Services disponibles :</p>
      <label class="block mb-1"><input type="checkbox" value="restaurant" class="mr-2 service"> Restaurant</label>
      <label class="block mb-1"><input type="checkbox" value="parking" class="mr-2 service"> Parking</label>
      <label class="block mb-1"><input type="checkbox" value="wifi" class="mr-2 service"> WiFi</label>
      <label class="block mb-1"><input type="checkbox" value="climatisation" class="mr-2 service"> Climatisation</label>
      <label class="block"><input type="checkbox" value="piscine" class="mr-2 service"> Piscine</label>
    </div>

    <input type="file" id="hotelImages" accept="image/*" multiple class="p-3 border rounded">

    <div id="progressBarContainer" class="hidden w-full bg-gray-200 rounded overflow-hidden">
      <div id="progressBar" class="h-2 bg-green-500 w-0"></div>
    </div>

    <button type="submit" class="bg-green-600 text-white px-4 py-3 rounded hover:bg-green-700">
      📤 Enregistrer l'hôtel
    </button>
  </form>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, onAuthStateChanged, setPersistence, browserLocalPersistence, signInWithRedirect
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc
  } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBo9JsPem6NqNWL1DHiPQFck5PLJvADRUI",
    authDomain: "congo-reservation.firebaseapp.com",
    projectId: "congo-reservation",
    storageBucket: "congo-reservation.appspot.com",
    messagingSenderId: "54528039217",
    appId: "1:54528039217:web:8158927e3b22c8a24a3810"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  setPersistence(auth, browserLocalPersistence).then(() => {
    onAuthStateChanged(auth, (user) => {
      if (user) {
        document.getElementById("authSection").classList.add("hidden");
        document.getElementById("formSection").classList.remove("hidden");
      }
    });
  });

  window.login = () => signInWithRedirect(auth, provider);

  async function uploadToCloudinary(file, index, total) {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "unsigned_upload");
    const res = await fetch("https://api.cloudinary.com/v1_1/dnemkgkyy/image/upload", {
      method: "POST",
      body: formData
    });
    updateProgressBar(index + 1, total);
    const data = await res.json();
    return data.secure_url;
  }

  function updateProgressBar(current, total) {
    const percent = Math.floor((current / total) * 100);
    const bar = document.getElementById("progressBar");
    bar.style.width = `${percent}%`;
  }

  document.getElementById("hotelForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const nom = document.getElementById("hotelNom").value;
    const ville = document.getElementById("hotelVille").value;
    const email = document.getElementById("hotelEmail").value;
    const description = document.getElementById("hotelDescription").value;

    const serviceCheckboxes = document.querySelectorAll(".service:checked");
    const services = Array.from(serviceCheckboxes).map(cb => cb.value);

    const files = document.getElementById("hotelImages").files;
    if (!files.length) return alert("Veuillez ajouter au moins une image.");

    const progressBar = document.getElementById("progressBarContainer");
    progressBar.classList.remove("hidden");
    updateProgressBar(0, files.length);

    const imageUrls = [];
    for (let i = 0; i < files.length; i++) {
      const url = await uploadToCloudinary(files[i], i, files.length);
      imageUrls.push(url);
    }

    await addDoc(collection(db, "hotels"), {
      nom,
      ville,
      email,
      description,
      services,
      images: imageUrls,
      validé: false,
      publie: false
    });

    alert("✅ Hôtel ajouté avec succès !");
    document.getElementById("hotelForm").reset();
    document.getElementById("progressBarContainer").classList.add("hidden");
    updateProgressBar(0, 1);
  });
</script>

</body>
</html>
