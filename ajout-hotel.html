<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ajout d'Hôtel</title>
  <style>
    .hidden { display: none; }
    .progress-bar-container {
      width: 100%;
      height: 10px;
      background-color: #e0e0e0;
      margin-top: 10px;
    }
    .progress-bar {
      height: 10px;
      width: 0%;
      background-color: #4caf50;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

  <!-- Connexion -->
  <div id="loginContainer">
    <h2>Connexion</h2>
    <button id="loginBtn">Se connecter avec Google</button>
  </div>

  <!-- Formulaire d'ajout -->
  <div id="formContainer" class="hidden">
    <h2>Ajouter un hôtel</h2>
    <form id="hotelForm">
      <label>Nom de l'hôtel:</label>
      <input type="text" name="nom" required><br>

      <label>Ville:</label>
      <input type="text" name="ville" required><br>

      <label>Email:</label>
      <input type="email" name="email" required><br>

      <label>Téléphone:</label>
      <input type="tel" name="telephone" required><br>

      <label>Site Web:</label>
      <input type="url" name="siteWeb"><br>

      <label>Description:</label><br>
      <textarea name="description" required></textarea><br>

      <label>Services :</label><br>
      <input type="checkbox" name="services" value="WiFi"> WiFi
      <input type="checkbox" name="services" value="Piscine"> Piscine
      <input type="checkbox" name="services" value="Parking"> Parking
      <input type="checkbox" name="services" value="Climatisation"> Climatisation
      <br><br>

      <label>Images de l'hôtel:</label>
      <input type="file" id="imagesInput" accept="image/*" multiple required><br><br>

      <div id="progressContainer" class="progress-bar-container hidden">
        <div id="progressBar" class="progress-bar"></div>
      </div>

      <button type="submit">Ajouter</button>
    </form>
  </div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithRedirect, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBo9JsPem6NqNWL1DHiPQFck5PLJvADRUI",
      authDomain: "congo-reservation.firebaseapp.com",
      projectId: "congo-reservation",
      storageBucket: "congo-reservation.appspot.com",
      messagingSenderId: "54528039217",
      appId: "1:54528039217:web:8158927e3b22c8a24a3810"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginContainer = document.getElementById("loginContainer");
    const formContainer = document.getElementById("formContainer");
    const loginBtn = document.getElementById("loginBtn");

    loginBtn.addEventListener("click", () => {
      sessionStorage.setItem("authRedirect", "true");
      signInWithRedirect(auth, provider);
    });

    onAuthStateChanged(auth, (user) => {
      const redirected = sessionStorage.getItem("authRedirect");
      if (user && redirected === "true") {
        sessionStorage.removeItem("authRedirect");
        loginContainer.style.display = "none";
        formContainer.style.display = "block";
      } else if (!user) {
        loginContainer.style.display = "block";
        formContainer.style.display = "none";
      }
    });

    async function uploadImageToCloudinary(file, index, total) {
      const data = new FormData();
      data.append("file", file);
      data.append("upload_preset", "unsigned_upload"); // à remplacer par ton preset Cloudinary

      try {
        const res = await fetch("https://api.cloudinary.com/v1_1/dnemkgkyy/image/upload", {
          method: "POST",
          body: data
        });

        if (!res.ok) throw new Error("Upload échoué.");

        const result = await res.json();
        updateProgress(index + 1, total);
        return result.secure_url;
      } catch (err) {
        console.error("Erreur Cloudinary :", err);
        alert("Erreur lors de l'envoi d'image. Veuillez réessayer.");
        throw err;
      }
    }

    function updateProgress(current, total) {
      const percent = Math.floor((current / total) * 100);
      document.getElementById("progressBar").style.width = percent + "%";
    }

    const hotelForm = document.getElementById("hotelForm");
    hotelForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formData = new FormData(hotelForm);
      const services = [...hotelForm.querySelectorAll("input[name='services']:checked")].map(cb => cb.value);
      const files = document.getElementById("imagesInput").files;
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");

      if (files.length === 0) return alert("Ajoutez au moins une image.");

      progressBar.style.width = "0%";
      progressContainer.classList.remove("hidden");

      const urls = [];
      try {
        for (let i = 0; i < files.length; i++) {
          const url = await uploadImageToCloudinary(files[i], i, files.length);
          urls.push(url);
        }

        await addDoc(collection(db, "hotels"), {
          nom: formData.get("nom"),
          ville: formData.get("ville"),
          email: formData.get("email"),
          telephone: formData.get("telephone"),
          siteWeb: formData.get("siteWeb") || "",
          description: formData.get("description"),
          services,
          images: urls,
          validé: false,
          publie: false,
          dateAjout: serverTimestamp()
        });

        alert("✅ Hôtel ajouté avec succès !");
        hotelForm.reset();

        setTimeout(() => {
          progressBar.style.width = "0%";
          progressContainer.classList.add("hidden");
        }, 1000);

      } catch (err) {
        console.log("Erreur :", err);
        progressContainer.classList.add("hidden");
      }
    });
  </script>

</body>
</html>
