<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ajout Hôtel</title>
</head>
<body>
  <h2>Ajouter un hôtel</h2>

  <button id="loginBtn">Connexion Google</button>
  <form id="hotelForm" style="display:none;">
    <input type="text" id="nom" placeholder="Nom de l'hôtel" required><br>
    <input type="text" id="ville" placeholder="Ville" required><br>
    <input type="text" id="adresse" placeholder="Adresse" required><br>
    <input type="number" id="prix" placeholder="Prix" required><br>
    <input type="text" id="contact" placeholder="Téléphone / WhatsApp" required><br>
    <input type="url" id="siteweb" placeholder="Site web (facultatif)"><br>
    
    <label>Services :</label><br>
    <input type="checkbox" name="services" value="WiFi"> WiFi<br>
    <input type="checkbox" name="services" value="Piscine"> Piscine<br>
    <input type="checkbox" name="services" value="Parking"> Parking<br>
    
    <label>Images de l'hôtel :</label>
    <input type="file" id="images" multiple accept="image/*" required><br><br>

    <button type="submit">Envoyer</button>
  </form>

  <script type="module">
    // === IMPORTS FIREBASE ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // === CONFIGURATION FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyBo9JsPem6NqNWL1DHiPQFck5PLJvADRUI",
      authDomain: "congo-reservation.firebaseapp.com",
      projectId: "congo-reservation",
      storageBucket: "congo-reservation.appspot.com",
      messagingSenderId: "54528039217",
      appId: "1:54528039217:web:8158927e3b22c8a24a3810",
      measurementId: "G-E4MZGSVB4H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    // === LOGIN GOOGLE ===
    document.getElementById("loginBtn").addEventListener("click", () => {
      signInWithRedirect(auth, provider);
    });

    // === VERIFIER LE RETOUR DE LA REDIRECTION ===
    getRedirectResult(auth)
      .then((result) => {
        if (result && result.user) {
          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("hotelForm").style.display = "block";
        }
      })
      .catch((error) => {
        console.error("Erreur login redirect:", error);
      });

    // === UPLOAD IMAGES TO CLOUDINARY ===
    async function uploadImagesToCloudinary(files) {
      const uploadedUrls = [];
      for (const file of files) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", "unsigned_upload");

        const res = await fetch("https://api.cloudinary.com/v1_1/dnemkgkyy/image/upload", {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        uploadedUrls.push(data.secure_url);
      }
      return uploadedUrls;
    }

    // === ENVOI DU FORMULAIRE ===
    document.getElementById("hotelForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const services = Array.from(document.querySelectorAll("input[name='services']:checked"))
                            .map(cb => cb.value);

      const images = document.getElementById("images").files;
      const imageUrls = await uploadImagesToCloudinary(images);

      const docData = {
        nom: document.getElementById("nom").value,
        ville: document.getElementById("ville").value,
        adresse: document.getElementById("adresse").value,
        prix: parseFloat(document.getElementById("prix").value),
        contact: document.getElementById("contact").value,
        siteweb: document.getElementById("siteweb").value || "",
        services: services,
        images: imageUrls,
        dateAjout: new Date()
      };

      try {
        await addDoc(collection(db, "hotels"), docData);
        alert("Hôtel ajouté avec succès !");
        document.getElementById("hotelForm").reset();
      } catch (err) {
        alert("Erreur d'envoi : " + err.message);
      }
    });
  </script>
</body>
</html>
